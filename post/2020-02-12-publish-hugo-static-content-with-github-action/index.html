<!DOCTYPE html>
<html lang="en-us">
    <head>
	<title>Publish Hugo Static Content With Github Action - LC</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="author" content="Lulu Cheng">
	<meta name="description" content="LC">
	<meta name="keywords" content="Tech, Data Engineering, Machine Learning, Data Science, Economics, Politics, Social Science, Software Engineering">
	<meta name="generator" content="Hugo 0.64.1" />

	
	<link rel="stylesheet" href="https://l1990790120.github.io/css/theme.css"/>
	
	
	<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

	<!-- CSS -->
	<link rel="stylesheet" href="https://l1990790120.github.io/css/main.css">

	

	<!--Favicon-->
	<link rel="shortcut icon" href="https://l1990790120.github.io/favicon.ico" type="image/x-icon">

	<!-- RSS -->
	

	<!-- Font Awesome -->
	<link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

	<!-- Google Fonts -->
	<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic" rel="stylesheet" type="text/css">

  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/default.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
</head>

    <body>
        <div class="row">
            <script>
	
	(function ($) {

	var previousScroll = 20;
		
		$(window).scroll(function(e) {
		
			
			var scroll = $(window).scrollTop();
			if (scroll >= previousScroll) {
				$('.navbar').addClass("navbar-hide");
			
			}else if (scroll < previousScroll) {
				$('.navbar').removeClass("navbar-hide");
			}
			previousScroll = scroll;
		
		});
		
	})(jQuery);    
</script>

<style>
	.navbar {
		transition: top 0.5s ease;
	}

	.navbar-hide {
		top: -100px;
	}
</style>

<nav class="navbar fixed-top navbar-expand-md navbar-light bg-white">
	<a class="navbar-brand" href="https://l1990790120.github.io/">
		<img
			class="avatar"
			src="https://l1990790120.github.io/profile.png"
			alt=""
		/>
	</a>
	<a class="navbar-brand" href="https://l1990790120.github.io/">LC</a>

	<button
		class="navbar-toggler"
		type="button"
		data-toggle="collapse"
		data-target="#navbarSupportedContent"
		aria-controls="navbarSupportedContent"
		aria-expanded="false"
		aria-label="Toggle navigation"
	>
		<span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
		<ul class="navbar-nav mr-auto">
			<li class="nav-item">
				<a class="nav-link" href="/about/"
					>About
					<span class="sr-only">(current)</span>
				</a>
			</li><li class="nav-item">
				<a class="nav-link" href="/"
					>Blog
					<span class="sr-only">(current)</span>
				</a>
			</li><li class="nav-item">
				<a class="nav-link" href="/generative-art/"
					>Generative Art
					<span class="sr-only">(current)</span>
				</a>
			</li>
		</ul>
		  <a
	href="mailto:l1990790120@gmail.com"
	title="Email"
>
	<i class="fa fa-fw fa-envelope"></i>
</a>    <a
	href="https://www.facebook.com/l1990790120"
	title="Facebook"
>
	<i class="fa fa-fw fa-facebook"></i>
</a>  <a
	href="https://github.com/l1990790120"
	title="GitHub"
>
	<i class="fa fa-fw fa-github"></i>
</a> <a
	href="http://instagram.com/l1990790120"
	title="Instagram"
>
	<i class="fa fa-fw fa-instagram"></i>
</a> <a
	href="https://www.linkedin.com/in/luluchengengineeratheart"
	title="LinkedIn"
>
	<i class="fa fa-fw fa-linkedin"></i>
</a> <a
	href="http://www.pinterest.com/l1990790120"
	title="Pinterest"
>
	<i class="fa fa-fw fa-pinterest"></i>
</a> <a
	href="https://www.reddit.com/user/l1990790120"
	title="Reddit"
>
	<i class="fa fa-fw fa-reddit"></i>
</a>     <a
	href="https://twitter.com/l1990790120"
	title="Twitter"
>
	<i class="fa fa-fw fa-twitter"></i>
</a>  <a
	href="https://www.youtube.com/user/l1990790120"
	title="YouTube"
>
	<i class="fa fa-fw fa-youtube"></i>
</a>   <a
	href="https://medium.com/@l1990790120"
	title=""
>
	<i class="fa fa-fw fa-medium"></i>
</a>

	</div>
</nav>

		</div>

		
		<div class="top-container col mr-auto">
			<div class="container text-wrap">
				<div class="pt-3">
		<h1 class="title text-center">Publish Hugo Static Content With Github Action</h1>
	</div>

	
	<style>
.post-meta{
    text-transform:uppercase;
    letter-spacing:0.1em;
    font-size: 90%;
}
</style>

<div>
    <div class="row text-secondary post-meta py-1">
        2020/02/12
        
        &middot; 
        
        4
        minute read
    </div>

    <div class="row post-meta pb-3 pt-1">
        
        <a href="https://l1990790120.github.io/tags/blog" class="badge badge-light">blog</a>
             &nbsp; <a href="https://l1990790120.github.io/tags/cicd" class="badge badge-light">cicd</a>
            
    </div>
</div>
	

	
	<div>
  

<p>About two days ago, one of my coworkers was so fed up by Jenkins and decided to try Github Action. I&rsquo;ve been thinking about automating publishing <a href="http://l1990790120.github.io/">this github site</a> since &hellip; the day I set it up. At work, if I have to setup a CD pipeline, I&rsquo;d usually put it on Jenkins. But at home, I just want to sit back and relax, I don&rsquo;t want to spend my Netflix time fixing Jenkins (which unfortunately it breaks all the time at work). So, I decided to find a way to setup automated static content publishing process (or the fancy term &ndash; CD) in Github Action for this site (repo: <a href="https://github.com/l1990790120/l1990790120.github.io">https://github.com/l1990790120/l1990790120.github.io</a>).</p>

<h2 id="auto-publish-custom-hugo-docker-image">Auto Publish Custom Hugo Docker Image<a href="#auto-publish-custom-hugo-docker-image" class="hanchor" ariaLabel="Anchor">   ¶</a> </h2>

<p>First tricky thing, because I need to embed ipython notebook and it&rsquo;s usually way bigger than normal static content page size, I have to re-compile hugo to workaround some annoying file length limit. I forked the official hugo repo and added some of my own changes on develop here: <a href="https://github.com/l1990790120/hugo">https://github.com/l1990790120/hugo</a>. If you compare tags with <code>-p</code> versus the official release tag, you can easily find the changes I&rsquo;ve made on my own: <a href="https://github.com/gohugoio/hugo/compare/v0.64.1...l1990790120:v0.64.1-p">https://github.com/gohugoio/hugo/compare/v0.64.1&hellip;l1990790120:v0.64.1-p</a>.</p>

<p>Now, for the CD process, I need to following things to happen:</p>

<ol>
<li>Once a while, pull the latest release from upstream official hugo repo, apply my own change and publish a new patched tag (official release tag with a <code>-p</code>).</li>
<li>If I push updates to my forking repo, update the latest release patched tag with new changes.</li>
<li>For any tag pushed, build and publish custom docker image to docker hub here: <a href="https://hub.docker.com/repository/docker/l1990790120/hugo">https://hub.docker.com/repository/docker/l1990790120/hugo</a></li>
</ol>

<p>For the first two items, I&rsquo;ve created a <a href="https://github.com/l1990790120/hugo/blob/develop/.github/workflows/push-forked-tag.yaml">push-forked-tag.yaml</a> that does the following:<br />
Every time there&rsquo;s a new push to develop, get the latest tag in upstream (official hugo repo), checkout and cherry-pick all commits from my forking repo, and then publish a patched tag accordingly.<br />
For the third one, I&rsquo;ve created another <a href="https://github.com/l1990790120/hugo/blob/develop/.github/workflows/publish-docker-tag.yaml">publish-docker-tag.yaml</a> that simply grab the any push to tags, build and publish image to docker hub accordingly.</p>

<h3 id="weird-limitation-workaround">Weird Limitation Workaround<a href="#weird-limitation-workaround" class="hanchor" ariaLabel="Anchor">   ¶</a> </h3>

<p>Along the way I&rsquo;ve also discovered some interesting limitations in Github Action. These two workflows, when running independently, there&rsquo;s no issues at all. The expected flow is that the first workflow triggers the second one by pushing a tag. However, Github Action has a weird limitation such that one workflow cannot trigger another workflow with the same github token (more details discussed here: <a href="https://github.community/t5/GitHub-Actions/Triggering-a-new-workflow-from-another-workflow/td-p/31676">https://github.community/t5/GitHub-Actions/Triggering-a-new-workflow-from-another-workflow/td-p/31676</a>). I have to create a separate token and feed it into the job. Obviously this introduced several drawbacks as discussed in the above thread also.</p>

<p>Note, I only have to add this extra step because the way I am embedding jupyter notebook. If you don&rsquo;t need to push hugo to its limit, just simply build the tag you need from <a href="https://github.com/gohugoio/hugo/blob/master/Dockerfile">https://github.com/gohugoio/hugo/blob/master/Dockerfile</a> and use it.</p>

<h2 id="set-up-publish">Set Up Publish<a href="#set-up-publish" class="hanchor" ariaLabel="Anchor">   ¶</a> </h2>

<p>On <a href="https://gohugo.io/hosting-and-deployment/hosting-on-github/#put-it-into-a-script">hugo docs</a>, there&rsquo;s detailed instruction on how to publish to github page. The <a href="https://github.com/l1990790120/l1990790120.github.io/blob/develop/.github/workflows/publish.yml">publish.yml</a> in my github site&rsquo;s repo literally just copy the doc, but instead of calling hugo binary directly, I put a docker run command with the image I just built from the prior step:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker run --rm -v <span style="color:#66d9ef">$(</span>pwd<span style="color:#66d9ef">)</span>:/site -v <span style="color:#66d9ef">$(</span>pwd<span style="color:#66d9ef">)</span>/public:/site/public l1990790120/hugo:0.64.1-p <span style="color:#e6db74">&#34;&#34;</span></code></pre></div>
<p>That&rsquo;s all. Now I never to look at these commands again. Anything I merge into <code>develop</code> will get published automatically.</p>

<h2 id="summary">Summary<a href="#summary" class="hanchor" ariaLabel="Anchor">   ¶</a> </h2>

<p>This adventure took me maybe less than two days. For a pipeline I have been procrastinated to setup for more than 3 years, I really appreciate this feature, and it&rsquo;s almost guaranteed to be free for light usage like this. Obviously the same thing can be done in Jenkins, TravisCI, CircleCI, Cloud Build, there&rsquo;s no doubt about that.</p>

<p>For more containerized CI/CD, for example, one of the CI/CD I had setup needed to use Docker Buildkit to build image. I really need to do some complicated stuff (running docker in docker and build the image against docker in docker daemon etc.) with my CI/CD pipeline (details in my <a href="https://stackoverflow.com/questions/57175062/using-docker-buildkit-on-google-cloud-build/58440922#58440922">Stack Overflow answer</a>). I can see developing complex pipeline in Github Action can be painful &ndash; solely because there&rsquo;s no easy way for me to test this locally (or maybe it&rsquo;s just that I am not aware of in the matter of two days, but I am happy to learn).</p>

<p>The syntax is also not as &ldquo;container-native&rdquo; as some of the other tools out there - CircleCI, Cloud Build. However, I feel this is a conscious decision from github to make the interface simpler. Overall, for light weight pipelines such as the one above or things like closing PR, Issues, generate release notes etc. I highly recommend to try Github Action first if you are setting up new ones.</p>

<p>Happy CI/CD!</p>

</div>

<style>
  .hanchor {
    font-size: 100%;
    visibility: hidden;
    color:silver;
  }
  h1:hover a, h2:hover a, h3:hover a, h4:hover a {
    visibility: visible;
    text-decoration: none;
  }
</style>
	


	
		<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "l1990790120" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	
			</div>
		</div>

        
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-71133003-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    </body>
</html>
